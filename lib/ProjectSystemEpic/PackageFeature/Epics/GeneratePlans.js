"use babel";
// @flow

import Rx from "rxjs";
import { List } from "immutable";
import { addPlanConfig } from "../../../ExecutionControlEpic/PlanConfigurationFeature/Actions/AddPlanConfig";
import type { AddPlanConfigAction } from "../../../ExecutionControlEpic/PlanConfigurationFeature/Actions/AddPlanConfig";
import { removeGeneratedPlans } from "../../../ExecutionControlEpic/PlanConfigurationFeature/Actions/RemoveGeneratedPlans";
import { selectPlansOfTool } from "../../../ExecutionControlEpic/PlanConfigurationFeature/Selectors/PlanConfigs";
import { selectPlansReducer } from "../../../GlobalSystem/Selectors";

import currentDate from "moment";
import { addConsoleLogsForTask } from "../../../ExecutionControlEpic/ConsoleFeature/Actions/AddConsoleLog";
import { ConsoleLogError } from "../../../ExecutionControlEpic/ConsoleFeature/Types/types";

import type {
  GeneratedPlanObject,
  PlanConfig,
} from "../../../ExecutionControlEpic/PlanConfigurationFeature/Types/types.js.flow";
import type { Package, PackagesRefreshedAction } from "../Types/types.js.flow";
import { generatePlanId } from "../../../ExecutionControlEpic/PlanConfigurationFeature/Model/id";

function _getDateString() {
  return currentDate().format("DD-MM-YYYY kk:mm:ss");
}

const generatePlansEpic = (getDateString = _getDateString) => (
  action$: Observable,
  store: Store,
) => {
  return action$
    .ofType("PACKAGES_REFRESHED")
    .map((action: PackagesRefreshedAction) => {
      return Rx.Observable.from(action.payload.packages)
        .map(async (packageInfo: Package) => {
          if (packageInfo.plugin.generatePlansForPackage == null) {
            return [];
          }
          const plansForTool: List<PlanConfig> = selectPlansOfTool(
            selectPlansReducer(store.getState()),
            packageInfo.plugin.tool.id,
          );
          const generatedPlans = await packageInfo.plugin.generatePlansForPackage(
            packageInfo.path,
          );
          if (!Array.isArray(generatedPlans)) {
            throw new Error("generatePlansForPackage must return an array");
          }
          const generatePlanActions = generatedPlans
            .map((planObject: GeneratedPlanObject) =>
              // TODO - Remove hard-coded values
              addPlanConfig({
                id: generatePlanId(),
                name: planObject.name,
                tool: packageInfo.plugin.tool,
                config: planObject.value,
                packageInfo,
                autoGenerated: true,
                autoRun: planObject.autoRun,
                pinned: planObject.autoRun === true ? true : false,
              }),
            )
            .filter(
              (action: AddPlanConfigAction) =>
                plansForTool.findIndex(
                  (config: PlanConfig) =>
                    config.name === action.payload.name &&
                    config.packageInfo.path === packageInfo.path &&
                    config.autoGenerated === false,
                ) === -1,
            );
          return [
            removeGeneratedPlans(packageInfo.plugin.tool, packageInfo.path),
            ...generatePlanActions,
          ];
        })
        .mergeAll()
        .catch(err => {
          return Rx.Observable.of([
            addConsoleLogsForTask({
              source: "Molecule",
              color: "#592b71",
              version: "0.4.0",
              severity: ConsoleLogError,
              message: `Error generating plans for toolName with package package.json: ${
                err.message
              }`,
              date: getDateString(),
            }),
          ]);
        })
        .mergeAll();
    })
    .mergeAll();
};

export default generatePlansEpic;
